{% extends 'memory_assistant/base.html' %}

{% block title %}Memory Detail - Memora{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Memory Content -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-journal-text"></i> Memory Details
                </h5>
                <div class="btn-group" role="group">
                    {% if memory.user == user %}
                        <a href="{% url 'memory_assistant:edit_memory' memory.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href="{% url 'memory_assistant:share_memory' memory.id %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-share"></i> Share
                        </a>
                        <a href="{% url 'memory_assistant:delete_memory' memory.id %}" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    {% else %}
                        <a href="{% url 'memory_assistant:profile' memory.user.username %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-person"></i> View Profile
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <span class="badge bg-primary importance-badge">
                            Importance: {{ memory.importance }}/10
                        </span>
                    </div>
                    <div class="col-md-4 text-center">
                        <span class="badge bg-secondary importance-badge">
                            {{ memory.get_memory_type_display }}
                        </span>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge 
                            {% if memory.privacy_level == 'private' %}bg-dark
                            {% elif memory.privacy_level == 'friends' %}bg-info
                            {% elif memory.privacy_level == 'organization' %}bg-warning
                            {% else %}bg-success{% endif %}">
                            {% if memory.privacy_level == 'private' %}
                                <i class="bi bi-lock"></i> Private
                            {% elif memory.privacy_level == 'friends' %}
                                <i class="bi bi-people"></i> Friends
                            {% elif memory.privacy_level == 'organization' %}
                                <i class="bi bi-building"></i> Organization
                            {% else %}
                                <i class="bi bi-globe"></i> Public
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <h6 class="card-title">Content</h6>
                <div class="border rounded p-3 bg-light mb-3">
                    {{ memory.content|linebreaks }}
                </div>
                
                {% if memory.image %}
                    <h6 class="card-title">Image</h6>
                    <div class="mb-3">
                        <img src="{{ memory.image.url }}" class="img-fluid rounded" alt="Memory image" 
                             style="max-width: 100%; max-height: 400px; cursor: pointer;" 
                             onclick="openImageModal(this.src)">
                    </div>
                {% endif %}
                
                {% if memory.summary %}
                    <h6 class="card-title">AI Summary</h6>
                    <div class="border rounded p-3 bg-light mb-3">
                        <p class="mb-0">{{ memory.summary }}</p>
                    </div>
                {% endif %}
                
                {% if memory.ai_reasoning %}
                    <h6 class="card-title">AI Reasoning</h6>
                    <div class="border rounded p-3 bg-light mb-3">
                        <p class="mb-0 text-muted">
                            <i class="bi bi-lightbulb"></i> 
                            {{ memory.ai_reasoning }}
                        </p>
                    </div>
                {% endif %}
                
                {% if memory.tags %}
                    <h6 class="card-title">Tags</h6>
                    <div class="mb-3">
                        {% for tag in memory.tags %}
                            <span class="badge bg-info tag-badge">{{ tag }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="row text-muted small">
                    <div class="col-md-6">
                        <i class="bi bi-calendar-plus"></i> Created: {{ memory.created_at|date:"F j, Y, g:i a" }}
                    </div>
                    <div class="col-md-6 text-end">
                        <i class="bi bi-calendar-check"></i> Updated: {{ memory.updated_at|date:"F j, Y, g:i a" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'memory_assistant:edit_memory' memory.id %}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Edit Memory
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="readMemoryAloud()">
                        <i class="bi bi-volume-up"></i> Read Aloud
                    </button>
                    <form method="POST" action="{% url 'memory_assistant:archive_memory' memory.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-warning w-100">
                            <i class="bi bi-archive"></i> 
                            {% if memory.is_archived %}Unarchive{% else %}Archive{% endif %}
                        </button>
                    </form>
                    <a href="{% url 'memory_assistant:delete_memory' memory.id %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Delete Memory
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Memory Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Memory Information
                </h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">Type:</dt>
                    <dd class="col-sm-6">{{ memory.get_memory_type_display }}</dd>
                    
                    <dt class="col-sm-6">Importance:</dt>
                    <dd class="col-sm-6">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {% widthratio memory.importance 1 10 %}%"
                                 aria-valuenow="{{ memory.importance }}" 
                                 aria-valuemin="0" aria-valuemax="10">
                                {{ memory.importance }}/10
                            </div>
                        </div>
                    </dd>
                    
                    <dt class="col-sm-6">Status:</dt>
                    <dd class="col-sm-6">
                        {% if memory.is_archived %}
                            <span class="badge bg-warning">Archived</span>
                        {% else %}
                            <span class="badge bg-success">Active</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Tags Count:</dt>
                    <dd class="col-sm-6">{{ memory.tags|length }}</dd>
                </dl>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-arrow-left-right"></i> Navigation
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'memory_assistant:memory_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-list-ul"></i> All Memories
                    </a>
                    <a href="{% url 'memory_assistant:create_memory' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> New Memory
                    </a>
                    <a href="{% url 'memory_assistant:dashboard' %}" class="btn btn-outline-info">
                        <i class="bi bi-house"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function readMemoryAloud() {
    fetch('{% url "memory_assistant:voice_read_memory" memory.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show a brief notification that memory is being read
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-volume-up"></i> Reading...';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        } else {
            alert('Failed to read memory aloud: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error reading memory aloud: ' + error);
    });
}

function openImageModal(imageSrc) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('imageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'imageModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Memory Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="modalImage" class="img-fluid" alt="Memory image">
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Set image source and show modal
    document.getElementById('modalImage').src = imageSrc;
    new bootstrap.Modal(modal).show();
}
</script>
{% endblock %} 