{% extends 'memory_assistant/base.html' %}
{% load memory_extras %}

{% block title %}Search Results - Memora{% endblock %}

{% block content %}
<div class="row">
    <!-- Search Header -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-2">
                            <i class="bi bi-search"></i> Search Results
                        </h4>
                        <p class="text-muted mb-0">
                            {% if search_method == "date_filter_only" %}
                                Found {{ results_count }} memory{{ results_count|pluralize }} from {{ date_filter }}
                                <span class="badge bg-primary ms-2">Date Filter</span>
                            {% else %}
                                Found {{ results_count }} memory{{ results_count|pluralize }} for "{{ query }}"
                                {% if date_filter %} on {{ date_filter }}{% endif %}
                                {% if search_method == "ai_semantic" %}
                                    <span class="badge bg-success ms-2">AI Semantic Search</span>
                                {% elif search_method == "enhanced_basic" %}
                                    <span class="badge bg-info ms-2">Enhanced Search</span>
                                {% elif search_method == "fuzzy" %}
                                    <span class="badge bg-warning ms-2">Fuzzy Match</span>
                                {% elif search_method == "suggestions" %}
                                    <span class="badge bg-secondary ms-2">Recent Suggestions</span>
                                {% endif %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'memory_assistant:memory_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to All Memories
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Refine Search -->
    <div class="col-12 mb-4">
        <div class="modern-refine-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; padding: 2rem; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
            <div class="refine-header mb-3">
                <h6 class="mb-0" style="color: #495057; font-weight: 600;">
                    <i class="bi bi-funnel me-2" style="color: #667eea;"></i> Filters & Search
                </h6>
                <p class="text-muted mb-0 mt-1" style="font-size: 0.9rem;">Refine your search criteria</p>
            </div>
            
            <form method="GET" action="{% url 'memory_assistant:search_memories' %}" class="modern-refine-form">
                <div class="row g-3 align-items-end">
                    <!-- Search Query -->
                    <div class="col-lg-4 col-md-6">
                        <div class="refine-group">
                            <label for="q" class="form-label" style="font-weight: 600; color: #495057; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="bi bi-search me-1" style="color: #667eea;"></i>Search Query
                            </label>
                            <div class="input-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden;">
                                <input type="text" class="form-control border-0 shadow-none" id="q" name="q" 
                                       value="{{ query }}" placeholder="Search by meaning, not just keywords..."
                                       style="border: none; outline: none; padding: 0.75rem 1rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Type -->
                    <div class="col-lg-2 col-md-6">
                        <div class="refine-group">
                            <label for="search_type" class="form-label" style="font-weight: 600; color: #495057; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="bi bi-gear me-1" style="color: #667eea;"></i>Search Type
                            </label>
                            <div class="input-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden;">
                                <select class="form-control border-0 shadow-none" id="search_type" name="search_type" 
                                        style="border: none; outline: none; padding: 0.75rem 1rem;">
                                    <option value="hybrid" {% if search_type == 'hybrid' %}selected{% endif %}>Hybrid (Recommended)</option>
                                    <option value="semantic" {% if search_type == 'semantic' %}selected{% endif %}>Semantic Only</option>
                                    <option value="keyword" {% if search_type == 'keyword' %}selected{% endif %}>Keyword Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date Filter -->
                    <div class="col-lg-2 col-md-6">
                        <div class="refine-group">
                            <label for="date_filter" class="form-label" style="font-weight: 600; color: #495057; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <i class="bi bi-calendar3 me-1" style="color: #667eea;"></i>Date Filter
                            </label>
                            <div class="input-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden;">
                                <input type="date" class="form-control border-0 shadow-none" id="date_filter" name="date_filter" 
                                       value="{{ date_filter }}"
                                       style="border: none; outline: none; padding: 0.75rem 1rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Button -->
                    <div class="col-lg-2 col-md-6">
                        <div class="refine-group">
                            <button type="submit" class="btn btn-primary w-100" 
                                    style="background: #667eea; border: none; border-radius: 12px; padding: 0.75rem 1rem; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                <i class="bi bi-search me-2"></i>Search
                            </button>
                        </div>
                    </div>
                    
                    <!-- Clear Button -->
                    <div class="col-lg-2 col-md-6">
                        <div class="refine-group">
                            <a href="{% url 'memory_assistant:search_memories' %}" class="btn btn-outline-secondary w-100"
                               style="border-radius: 12px; padding: 0.75rem 1rem; font-weight: 600;">
                                <i class="bi bi-x-circle me-2"></i>Clear
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <style>
    .modern-refine-container {
        position: relative;
        overflow: hidden;
    }
    
    .modern-refine-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
        pointer-events: none;
    }
    
    .modern-refine-form {
        position: relative;
        z-index: 1;
    }
    
    .refine-group .input-wrapper:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        transition: all 0.3s ease;
    }
    
    .refine-group .form-control:focus {
        box-shadow: none;
        border: none;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .modern-refine-container {
            padding: 1.5rem;
        }
        
        .refine-group {
            margin-bottom: 1rem;
        }
    }
    </style>

    <!-- Search Results -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-robot"></i> AI-Powered Search Results
                </h5>
            </div>
            <div class="card-body">
                {% if search_results %}
                    {% if search_method == "date_filter_only" %}
                        <div class="alert alert-primary">
                            <i class="bi bi-calendar"></i>
                            <strong>Date Filter:</strong> Showing all memories created on {{ date_filter }}.
                        </div>
                    {% elif search_method == "semantic_search" %}
                        <div class="alert alert-success">
                            <i class="bi bi-robot"></i>
                            <strong>Semantic Search:</strong> Results are ranked by semantic similarity using AI embeddings. Understanding meaning, not just keywords.
                        </div>
                    {% elif search_method == "hybrid_search" %}
                        <div class="alert alert-success">
                            <i class="bi bi-robot"></i>
                            <strong>Hybrid Search:</strong> Results combine semantic understanding with keyword matching for optimal relevance.
                        </div>
                    {% elif search_method == "ai_semantic" %}
                        <div class="alert alert-success">
                            <i class="bi bi-robot"></i>
                            <strong>AI Semantic Search:</strong> Results are ranked by semantic relevance using advanced AI analysis.
                        </div>
                    {% elif search_method == "enhanced_basic" %}
                        <div class="alert alert-info">
                            <i class="bi bi-search"></i>
                            <strong>Enhanced Search:</strong> Results found using comprehensive keyword matching across content, summary, tags, and AI reasoning.
                        </div>
                    {% elif search_method == "fuzzy" %}
                        <div class="alert alert-warning">
                            <i class="bi bi-search"></i>
                            <strong>Fuzzy Match:</strong> Results found using partial word matching. Try more specific search terms for better results.
                        </div>
                    {% elif search_method == "suggestions" %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-lightbulb"></i>
                            <strong>Recent Memories:</strong> No exact matches found. Showing your most recent memories as suggestions.
                        </div>
                    {% elif search_method == "contextual_suggestions" %}
                        <div class="alert alert-info">
                            <i class="bi bi-lightbulb"></i>
                            <strong>AI Contextual Suggestions:</strong> No memories found for your query. Here are some helpful suggestions:
                        </div>
                    {% endif %}
                    
                    <!-- Search Intent Analysis -->
                    {% if search_intent and query %}
                        <div class="alert alert-info">
                            <i class="bi bi-brain"></i>
                            <strong>Search Intent Analysis:</strong>
                            <div class="mt-2">
                                {% if search_intent.query_type == 'time_based' %}
                                    <span class="badge bg-primary me-2">Time-based search</span>
                                {% endif %}
                                {% if search_intent.is_question %}
                                    <span class="badge bg-success me-2">Question detected</span>
                                {% endif %}
                                {% if search_intent.memory_types %}
                                    <span class="badge bg-warning me-2">Memory types: {{ search_intent.memory_types|join:", " }}</span>
                                {% endif %}
                                {% if search_intent.keywords %}
                                    <span class="badge bg-info me-2">Keywords: {{ search_intent.keywords|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Search Suggestions -->
                    {% if search_suggestions %}
                        <div class="alert alert-warning">
                            <i class="bi bi-lightbulb"></i>
                            <strong>Search Suggestions:</strong> Try these related searches:
                            <div class="mt-2">
                                {% for suggestion in search_suggestions %}
                                    <a href="?q={{ suggestion|urlencode }}&search_type={{ search_type }}" 
                                       class="badge bg-light text-dark text-decoration-none me-2 mb-1">
                                        {{ suggestion }}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Similarity Scores for Semantic Search -->
                    {% if similarity_scores and search_method in 'semantic_search,hybrid_search' %}
                        <div class="alert alert-success">
                            <i class="bi bi-graph-up"></i>
                            <strong>Relevance Scores:</strong> Results are ranked by semantic similarity (higher scores = more relevant)
                        </div>
                    {% endif %}
                    
                    <!-- AI Search Suggestions -->
                    <div class="alert alert-warning" id="ai-suggestions" style="display: none;">
                        <i class="bi bi-lightbulb"></i>
                        <strong>AI Suggestions:</strong> Try these related search terms:
                        <div id="suggestions-list" class="mt-2"></div>
                    </div>
                    
                    <div class="row">
                        {% for memory in search_results %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card memory-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <span class="badge bg-primary importance-badge">
                                                    {{ memory.importance }}/10
                                                </span>
                                                <span class="badge bg-secondary importance-badge">
                                                    {{ memory.get_memory_type_display }}
                                                </span>
                                                {% if similarity_scores and memory.id in similarity_scores %}
                                                    <span class="badge bg-success importance-badge" title="Semantic similarity score">
                                                        {{ similarity_scores|get_item:memory.id|floatformat:2 }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <h6 class="card-title">{{ memory.content|truncatewords:20 }}</h6>
                                        
                                        {% if memory.summary %}
                                            <p class="card-text text-muted small">
                                                {{ memory.summary|truncatewords:25 }}
                                            </p>
                                        {% endif %}
                                        
                                        {% if memory.tags %}
                                            <div class="mb-3">
                                                {% for tag in memory.tags|slice:":4" %}
                                                    <span class="badge bg-light text-dark tag-badge">{{ tag }}</span>
                                                {% endfor %}
                                                {% if memory.tags|length > 4 %}
                                                    <span class="badge bg-light text-dark tag-badge">+{{ memory.tags|length|add:"-4" }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                {{ memory.created_at|date:"M j, Y" }}
                                            </small>
                                            <div class="btn-group" role="group">
                                                <a href="{% url 'memory_assistant:memory_detail' memory.id %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{% url 'memory_assistant:edit_memory' memory.id %}" 
                                                   class="btn btn-outline-secondary btn-sm">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No memories found</h5>
                        <p class="text-muted">
                            No memories match your search for "{{ query }}". 
                            Here are your recent memories:
                        </p>
                        
                        {% if search_results %}
                            <div class="row mt-4">
                                {% for memory in search_results %}
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card memory-card h-100 border-info">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <span class="badge bg-info importance-badge">
                                                        Recent Memory
                                                    </span>
                                                    <span class="badge bg-secondary importance-badge">
                                                        {{ memory.get_memory_type_display }}
                                                    </span>
                                                </div>
                                                
                                                <h6 class="card-title">{{ memory.content|truncatewords:20 }}</h6>
                                                
                                                {% if memory.summary %}
                                                    <p class="card-text text-muted small">
                                                        {{ memory.summary|truncatewords:25 }}
                                                    </p>
                                                {% endif %}
                                                
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        {{ memory.created_at|date:"M j, Y" }}
                                                    </small>
                                                    <div class="btn-group" role="group">
                                                        <a href="{% url 'memory_assistant:memory_detail' memory.id %}" 
                                                           class="btn btn-outline-primary btn-sm">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                        <a href="{% url 'memory_assistant:edit_memory' memory.id %}" 
                                                           class="btn btn-outline-secondary btn-sm">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if search_method == "contextual_suggestions" %}
                            <!-- Display contextual suggestions -->
                            <div class="row">
                                {% for suggestion in contextual_suggestions %}
                                    <div class="col-12 mb-3">
                                        <div class="card border-info">
                                            <div class="card-body">
                                                <div class="d-flex align-items-start">
                                                    <div class="flex-grow-1">
                                                        <p class="card-text mb-0">
                                                            <i class="bi bi-chat-quote text-info"></i> {{ suggestion }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-center gap-2 mt-4">
                            <a href="{% url 'memory_assistant:memory_list' %}" class="btn btn-primary">
                                <i class="bi bi-list-ul"></i> Browse All Memories
                            </a>
                            <a href="{% url 'memory_assistant:create_memory' %}" class="btn btn-outline-primary">
                                <i class="bi bi-plus-circle"></i> Create New Memory
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search Tips -->
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i> Search Tips
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Natural Language</h6>
                        <p class="text-muted small">
                            Use natural language like "meetings about project X" or "ideas for vacation planning" 
                            instead of just keywords.
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Context Matters</h6>
                        <p class="text-muted small">
                            The AI understands context, so you can search for concepts, emotions, or topics 
                            even if they're not explicitly mentioned.
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Be Specific</h6>
                        <p class="text-muted small">
                            More specific queries often yield better results. Include names, dates, or 
                            specific details when possible.
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Try Different Approaches</h6>
                        <p class="text-muted small">
                            If you don't find what you're looking for, try rephrasing your search or 
                            using related terms.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load AI search suggestions when page loads
document.addEventListener('DOMContentLoaded', function() {
    const query = '{{ query }}';
    if (query && query.trim() !== '') {
        loadAISearchSuggestions(query);
    }
});

function loadAISearchSuggestions(query) {
    fetch(`{% url 'memory_assistant:smart_search_suggestions' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.ai_available && data.suggestions.length > 0) {
                displaySearchSuggestions(data.suggestions);
            }
        })
        .catch(error => {
            console.log('Could not load AI search suggestions:', error);
        });
}

function displaySearchSuggestions(suggestions) {
    const suggestionsDiv = document.getElementById('ai-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    
    suggestionsList.innerHTML = '';
    suggestions.forEach(suggestion => {
        const suggestionElement = document.createElement('button');
        suggestionElement.className = 'btn btn-outline-warning btn-sm me-2 mb-2';
        suggestionElement.textContent = suggestion;
        suggestionElement.onclick = function() {
            window.location.href = `{% url 'memory_assistant:search_memories' %}?q=${encodeURIComponent(suggestion)}`;
        };
        suggestionsList.appendChild(suggestionElement);
    });
    
    suggestionsDiv.style.display = 'block';
}
</script>
{% endblock %} 