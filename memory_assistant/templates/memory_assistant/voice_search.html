{% extends 'memory_assistant/base.html' %}

{% block title %}Voice Search - Memora{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-search"></i> Voice Search Memories
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="bi bi-mic-fill display-1 text-primary"></i>
                    <h4 class="mt-3">Voice Search</h4>
                    <p class="text-muted">Speak your search query and find relevant memories</p>
                </div>
                
                <div class="mb-4">
                    <button id="startVoiceSearch" class="btn btn-primary btn-lg">
                        <i class="bi bi-mic"></i> Start Voice Search
                    </button>
                    <button id="stopVoiceSearch" class="btn btn-danger btn-lg" style="display: none;">
                        <i class="bi bi-stop-circle"></i> Stop Recording
                    </button>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Or test with text input:</small>
                    <div class="input-group">
                        <input type="text" id="testSearchInput" class="form-control" placeholder="Enter search query here...">
                        <button id="testSearchButton" class="btn btn-outline-secondary">
                            <i class="bi bi-search"></i> Test Search
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Quick test setup:</small>
                    <button id="createCatList" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-plus-circle"></i> Create Test Memories
                    </button>
                    <button id="debugMemories" class="btn btn-outline-warning btn-sm ms-2">
                        <i class="bi bi-bug"></i> Debug Memories
                    </button>
                </div>
                
                <div id="searchStatus" class="alert alert-info" style="display: none;">
                    <i class="bi bi-mic"></i> Listening for search query... Speak now!
                </div>
                
                <div id="searchResults" class="mt-4" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="resultsList" class="mt-3"></div>
                </div>
                
                <div id="searchError" class="alert alert-danger mt-3" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage"></span>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i> Voice Search Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Ask natural questions like "What did I learn about Python?"</li>
                    <li>Use descriptive terms: "meeting with John about project"</li>
                    <li>Mention dates: "memories from last week"</li>
                    <li>Reference topics: "ideas about marketing strategy"</li>
                    <li>Be specific for better results</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let isSearching = false;
let recognition = null;

// Check if browser supports speech recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
} else {
    document.getElementById('errorMessage').textContent = 'Speech recognition is not supported in this browser. Please use Chrome or Edge.';
    document.getElementById('searchError').style.display = 'block';
    document.getElementById('startVoiceSearch').disabled = true;
}

document.getElementById('startVoiceSearch').addEventListener('click', function() {
    startVoiceSearch();
});

document.getElementById('stopVoiceSearch').addEventListener('click', function() {
    stopVoiceSearch();
});

document.getElementById('testSearchButton').addEventListener('click', function() {
    const testQuery = document.getElementById('testSearchInput').value.trim();
    if (testQuery) {
        performSearch(testQuery);
    }
});

document.getElementById('createCatList').addEventListener('click', function() {
    // Create test memories
    fetch('{% url "memory_assistant:create_test_memory" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Test memories created! Now try searching for "what\'s plan for today" or "shopping list"');
            // Auto-fill the search input
            document.getElementById('testSearchInput').value = 'what\'s plan for today';
        } else {
            alert('Error creating test memories: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating test memories');
    });
});

document.getElementById('debugMemories').addEventListener('click', function() {
    // Check what memories exist in database
    fetch('{% url "memory_assistant:debug_memories" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Debug info:', data.debug_info);
            alert(`Total memories: ${data.debug_info.total_memories}\n\nRecent memories:\n${data.debug_info.recent_memories.map(m => `- ${m.content}`).join('\n')}`);
        } else {
            alert('Error getting debug info: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error getting debug info');
    });
});

function startVoiceSearch() {
    if (!recognition) {
        document.getElementById('errorMessage').textContent = 'Speech recognition not available';
        document.getElementById('searchError').style.display = 'block';
        return;
    }
    
    try {
        isSearching = true;
        document.getElementById('startVoiceSearch').style.display = 'none';
        document.getElementById('stopVoiceSearch').style.display = 'inline-block';
        document.getElementById('searchStatus').style.display = 'block';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('searchError').style.display = 'none';
        
        recognition.onresult = function(event) {
            const query = event.results[0][0].transcript;
            document.getElementById('testSearchInput').value = query;
            performSearch(query);
        };
        
        recognition.onend = function() {
            if (isSearching) {
                // Auto-restart if still searching
                recognition.start();
            } else {
                document.getElementById('startVoiceSearch').style.display = 'inline-block';
                document.getElementById('stopVoiceSearch').style.display = 'none';
                document.getElementById('searchStatus').style.display = 'none';
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            let errorMessage = 'Speech recognition error occurred';
            
            switch(event.error) {
                case 'no-speech':
                    errorMessage = 'No speech detected. Please try again.';
                    break;
                case 'audio-capture':
                    errorMessage = 'Microphone access denied. Please check permissions.';
                    break;
                case 'not-allowed':
                    errorMessage = 'Microphone access denied. Please allow microphone access.';
                    break;
                case 'network':
                    errorMessage = 'Network error occurred. Please check your connection.';
                    break;
                default:
                    errorMessage = 'Speech recognition error: ' + event.error;
            }
            
            document.getElementById('errorMessage').textContent = errorMessage;
            document.getElementById('searchError').style.display = 'block';
            stopVoiceSearch();
        };
        
        recognition.start();
        
        // Auto-stop after 15 seconds
        setTimeout(() => {
            if (isSearching) {
                stopVoiceSearch();
            }
        }, 15000);
        
    } catch (error) {
        console.error('Error starting speech recognition:', error);
        document.getElementById('errorMessage').textContent = 'Error starting speech recognition';
        document.getElementById('searchError').style.display = 'block';
        stopVoiceSearch();
    }
}

function stopVoiceSearch() {
    isSearching = false;
    if (recognition) {
        recognition.stop();
    }
    
    document.getElementById('startVoiceSearch').style.display = 'inline-block';
    document.getElementById('stopVoiceSearch').style.display = 'none';
    document.getElementById('searchStatus').style.display = 'none';
}

function performSearch(query) {
    console.log('Performing search for query:', query); // Debug log
    
    // Send text query to server for processing
    const formData = new FormData();
    formData.append('text', query);
    
    fetch('{% url "memory_assistant:voice_search_memories" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => {
        console.log('Search response status:', response.status); // Debug log
        return response.json();
    })
    .then(data => {
        console.log('Search response data:', data); // Debug log
        if (data.success) {
            displaySearchResults(data);
        } else {
            document.getElementById('errorMessage').textContent = data.error;
            document.getElementById('searchError').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('errorMessage').textContent = 'Network error occurred';
        document.getElementById('searchError').style.display = 'block';
    });
}

function displaySearchResults(data) {
    const resultsContainer = document.getElementById('searchResults');
    
    console.log('Displaying search results:', data); // Debug log
    
    if (data.results && data.results.length > 0) {
        let html = `<h5>Search Results for "${data.query}"</h5>`;
        
        data.results.forEach(memory => {
            html += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <p class="card-text">${memory.content}</p>
                                ${memory.summary ? `<small class="text-muted">${memory.summary}</small><br>` : ''}
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> ${memory.recency} 
                                    (${memory.created_at})
                                </small>
                            </div>
                            <div class="btn-group-vertical ms-2">
                                <button onclick="readMemory(${memory.id})" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-volume-up"></i> Read Aloud
                                </button>
                                <a href="/memora/memories/${memory.id}/" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block'; // Make sure it's visible
    } else if (data.suggestions && data.suggestions.length > 0) {
        let html = `<h5>${data.message}</h5>`;
        
        // Check if these are contextual suggestions (text strings) or memory objects
        if (data.contextual) {
            // Contextual suggestions are text strings
            html += `<div class="alert alert-info">
                <i class="bi bi-lightbulb"></i> <strong>AI Suggestions:</strong>
            </div>`;
            
            data.suggestions.forEach(suggestion => {
                html += `
                    <div class="card mb-3 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <p class="card-text mb-0">
                                        <i class="bi bi-chat-quote text-info"></i> ${suggestion}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            // These are memory objects (fallback case)
            data.suggestions.forEach(memory => {
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <p class="card-text">${memory.content}</p>
                                    ${memory.summary ? `<small class="text-muted">${memory.summary}</small><br>` : ''}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${memory.recency} 
                                        (${memory.created_at})
                                    </small>
                                </div>
                                <div class="btn-group-vertical ms-2">
                                    <button onclick="readMemory(${memory.id})" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-volume-up"></i> Read Aloud
                                    </button>
                                    <a href="/memora/memories/${memory.id}/" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block'; // Make sure it's visible
    } else {
        resultsContainer.innerHTML = `<div class="alert alert-info">No memories found for "${data.query}".</div>`;
        resultsContainer.style.display = 'block'; // Make sure it's visible
    }
}

function readMemory(memoryId) {
    fetch(`/memora/voice/read/${memoryId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Memory is being read aloud
        } else {
            alert('Failed to read memory aloud');
        }
    });
}
</script>
{% endblock %} 